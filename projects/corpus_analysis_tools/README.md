# Corpus Analysis Tools

This directory contains three core Python scripts for analyzing and manipulating corpora generated by the combination tool.

## Tools Overview

### 1. `filter_small_files.py`
**Purpose**: Filter corpora by file size and create sub-corpora containing the smallest files.

**Key Features**:
- Size-based filtering with configurable limits
- Creates multiple sub-corpora (10k, 40k, 70k files)
- Generates detailed statistics and analysis
- Preserves original file structure

**Usage**:
```bash
python3 filter_small_files.py <corpus_dir> [size_limit_kb] [output_dir]
```

**Examples**:
```bash
# Filter corpus with default 1024KB limit
python3 filter_small_files.py corpus_output/jpg_large_github_20250804_150558_real_attempt_1

# Filter with custom size limit (500KB)
python3 filter_small_files.py corpus_output/jpg_large_github_20250804_150558_real_attempt_1 500

# Specify output directory
python3 filter_small_files.py corpus_output/jpg_large_github_20250804_150558_real_attempt_1 1024 filtered_corpora
```

**Output**:
- `corpus_10k/`: 10,000 smallest files
- `corpus_40k/`: 40,000 smallest files  
- `corpus_70k/`: 70,000 smallest files
- Analysis report with file size statistics

---

### 2. `create_random_corpus.py`
**Purpose**: Create randomly sampled corpora from larger corpora.

**Key Features**:
- Random sampling with configurable sample size
- Source distribution analysis
- Multi-source attribution (credits files to all sources)
- Detailed statistics and reporting

**Usage**:
```bash
python3 create_random_corpus.py <source_corpus> <output_dir> <num_files>
```

**Examples**:
```bash
# Create 10,000 file random corpus
python3 create_random_corpus.py corpus_output/jpg_large_github_20250804_150558_real_attempt_1 filtered_corpora/corpus_random_10k_1 10000

# Create 5,000 file random corpus
python3 create_random_corpus.py corpus_output/jpg_large_github_20250804_150558_real_attempt_1 filtered_corpora/corpus_random_5k 5000
```

**Output**:
- Randomly sampled corpus directory
- Source distribution analysis
- File size statistics
- Multi-source attribution report

---

### 3. `trace_file_sources.py`
**Purpose**: Trace files back to their original source tools with multi-source attribution.

**Key Features**:
- SHA256 hash-based file matching
- Multi-source attribution (files credited to all sources)
- Detailed source distribution analysis
- JSON output for further processing
- Handles file renaming and deduplication

**Usage**:
```bash
python3 trace_file_sources.py <corpus_dir> [--output <json_file>] [--check-dirs]
```

**Examples**:
```bash
# Analyze corpus source distribution
python3 trace_file_sources.py filtered_corpora/corpus_10k

# Save results to JSON file
python3 trace_file_sources.py filtered_corpora/corpus_10k --output analysis_results.json

# Check source directories only
python3 trace_file_sources.py dummy --check-dirs
```

**Output**:
- Source distribution percentages
- Multi-source file counts
- Detailed breakdown by tool
- Optional JSON export

---

## Common Workflow

### Typical Analysis Pipeline:

1. **Generate corpus** using `combine.py`
2. **Filter by size** using `filter_small_files.py`
3. **Create random samples** using `create_random_corpus.py`
4. **Analyze source distribution** using `trace_file_sources.py`

### Example Complete Workflow:
```bash
# 1. Generate corpus (already done)
python3 combine.py -d -t 100 corpus_output/jpg_test jpg

# 2. Filter by size
python3 filter_small_files.py corpus_output/jpg_test

# 3. Create random sample
python3 create_random_corpus.py corpus_output/jpg_test filtered_corpora/corpus_random_10k 10000

# 4. Analyze sources
python3 trace_file_sources.py filtered_corpora/corpus_10k --output analysis.json
```

## Dependencies

All scripts require:
- Python 3.6+
- Standard library modules: `os`, `sys`, `argparse`, `hashlib`, `json`, `random`, `shutil`
- `collections.defaultdict` (for source counting)

## Output Formats

### Filter Script Output:
```
=== Corpus Analysis ===
Total files: 165,382
Total size: 3.2 GB
Average file size: 19.8 KB

=== Filtered Corpora ===
corpus_10k: 10,000 files (9.5 MB)
corpus_40k: 40,000 files (38.2 MB)  
corpus_70k: 70,000 files (66.8 MB)
```

### Random Corpus Output:
```
=== Random Corpus Created ===
Source: corpus_output/jpg_test
Output: filtered_corpora/corpus_random_10k_1
Files: 10,000
Size: 223.85 MB

=== Source Distribution ===
github_queries: 9,462 files (94.2%)
search_queries: 578 files (5.8%)
Files from multiple sources: 36
```

### Trace Script Output:
```
=== Source Distribution ===
github_queries: 9,971 files (99.5%)
search_queries: 49 files (0.5%)
bug_tracker: 2 files (0.0%)
Files from multiple sources: 17
```

## Notes

- All scripts handle file renaming and deduplication from the combination process
- Multi-source attribution ensures no undercounting of tool contributions
- Source directories are automatically detected from `trial-1` subdirectories
- JSON output enables further analysis and visualization 